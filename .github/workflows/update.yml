name: BDIX Stream Auto Updater

on:
  schedule:
    - cron: "0 */2 * * *"  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: Run Auto Stream Updater
        env:
          JSON_URL: ${{ secrets.JSON_URL }}
          TV_BASE_URL: ${{ secrets.TV_BASE_URL }}
        run: |
          mkdir -p apis

          cat > fetch.php << 'EOF'
          <?php
          $JSON_URL  = getenv("JSON_URL");
          $BASE_URL  = getenv("TV_BASE_URL");

          $OUTPUT_JSON = __DIR__ . "/apis/bdix.json";
          $OUTPUT_M3U  = __DIR__ . "/apis/playlist.m3u";

          echo "Loading source JSON...\n";
          $raw = file_get_contents($JSON_URL);
          if (!$raw) die("ERROR: Failed loading source JSON\n");

          $list = json_decode($raw, true);
          if (!is_array($list)) die("ERROR: Invalid JSON structure\n");

          $final = [];
          $m3u   = "#EXTM3U\n";

          foreach ($list as $item) {
              $id   = $item["id"];
              $name = $item["name"];
              $cate = $item["cate"];
              $logo = $item["logo"];

              $url  = $BASE_URL . urlencode($id);
              $html = @file_get_contents($url);

              if (!$html) {
                  echo "FAILED: $id (cannot load player)\n";
                  continue;
              }

              if (preg_match('/source:\s*"([^"]+)"/', $html, $m)) {
                  $stream = $m[1];
              } else {
                  echo "NO STREAM FOUND: $id\n";
                  continue;
              }

              echo "OK: $id\n";

              $final[] = [
                  "id" => $id,
                  "name" => $name,
                  "cate" => $cate,
                  "logo" => $logo,
                  "stream" => $stream
              ];

              $m3u .= "#EXTINF:-1 tvg-logo=\"$logo\" group-title=\"$cate\", $name\n";
              $m3u .= "$stream\n";
          }

          file_put_contents($OUTPUT_JSON, json_encode($final, JSON_PRETTY_PRINT));
          file_put_contents($OUTPUT_M3U, $m3u);

          echo "DONE: Updated bdix.json & playlist.m3u\n";
          ?>
          EOF

          php fetch.php

      - name: Commit & Push Updated Files
        run: |
          git config user.email "auto@github.com"
          git config user.name "AutoBot"
          git add apis/bdix.json playlist.m3u
          git commit -m "Auto update (streams refreshed)" || echo "No changes"
          git push
