name: BDIX Stream Auto Updater

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: Run Auto Stream Updater
        id: streamjob
        env:
          JSON_URL: ${{ secrets.JSON_URL }}
          TV_BASE_URL: ${{ secrets.TV_BASE_URL }}
        run: |
          mkdir -p apis

          cat > fetch.php << 'EOF'
          <?php
          $JSON_URL  = getenv("JSON_URL");
          $BASE_URL  = getenv("TV_BASE_URL");

          $OUTPUT_JSON = __DIR__ . "/apis/bdix.json";
          $OUTPUT_M3U  = __DIR__ . "/playlist.m3u";

          echo "Fetching JSON: $JSON_URL\n";
          $raw = @file_get_contents($JSON_URL);

          if (!$raw) {
              echo "FATAL_ERROR: Cannot load JSON_URL\n";
              file_put_contents("status.txt", "fail");
              exit(1);
          }

          $list = json_decode($raw, true);
          if (!is_array($list)) {
              echo "FATAL_ERROR: JSON invalid\n";
              file_put_contents("status.txt", "fail");
              exit(1);
          }

          $final = [];
          $m3u   = "#EXTM3U\n";

          foreach ($list as $item) {
              $id   = $item["id"];
              $name = $item["name"];
              $cate = $item["cate"];
              $logo = $item["logo"];

              $url = $BASE_URL . urlencode($id);
              $html = @file_get_contents($url);

              if (!$html) {
                  echo "FAILED: Cannot load $id\n";
                  continue;
              }

              if (preg_match('/source:\s*"([^"]+)"/', $html, $m)) {
                  $stream = $m[1];
              } else {
                  echo "NO STREAM FOUND: $id\n";
                  continue;
              }

              echo "OK: $id\n";

              $final[] = [
                  "id" => $id,
                  "name" => $name,
                  "cate" => $cate,
                  "logo" => $logo,
                  "stream" => $stream
              ];

              $m3u .= "#EXTINF:-1 tvg-logo=\"$logo\" group-title=\"$cate\", $name\n";
              $m3u .= "$stream\n";
          }

          file_put_contents($OUTPUT_JSON, json_encode($final, JSON_PRETTY_PRINT));
          file_put_contents($OUTPUT_M3U, $m3u);
          file_put_contents("status.txt", "ok");

          ?>
          EOF

          php fetch.php

      - name: Check Status Before Commit
        run: |
          STATUS=$(cat status.txt)
          if [ "$STATUS" = "fail" ]; then
            echo "Skipping commit because JSON failed."
            exit 0
          fi

      - name: Commit & Push Updated Files
        run: |
          git config user.email "auto@github.com"
          git config user.name "AutoBot"
          git add apis/bdix.json playlist.m3u
          git commit -m "Auto update" || true
          git push
