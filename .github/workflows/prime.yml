name: Auto Update Playlist

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Fetch homepage data and generate JSON
        run: |
          php -r '
          $baseDir = __DIR__ . "/pr";
          $baseURL = getenv("BASE_URL");
          if (!$baseURL) die("BASE_URL secret not set\n");

          // Browser User-Agent
          $opts = [
              "http" => [
                  "method" => "GET",
                  "header" => "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36\r\n"
              ]
          ];
          $context = stream_context_create($opts);

          // Fetch homepage JSON
          $homepageData = @file_get_contents("{$baseURL}/pv/homepage.php", false, $context);
          if(!$homepageData) die("Failed to fetch homepage.php\n");

          $data = json_decode($homepageData, true);
          if(!$data) die("Invalid JSON from homepage.php\n");

          // --- Slider ---
          $sliderOut = [];
          if(isset($data["slider"])) {
              foreach($data["slider"] as $item) {
                  $id = $item["id"];
                  $tm = time();
                  $playlistURL = "{$baseURL}/pv/playlist.php?id={$id}&tm={$tm}";
                  $jsonData = @file_get_contents($playlistURL, false, $context);
                  if(!$jsonData) continue;
                  $jsonArr = json_decode($jsonData, true);
                  if(isset($jsonArr[0])) {
                      $jsonArr[0]["image2"] = "https://imgcdn.kim/pv/341/{$id}.jpg";
                      $jsonArr[0]["image1"] = "https://imgcdn.kim/pv/c/{$id}.jpg";
                  }
                  $sliderOut[$id] = $jsonArr;
              }
              @mkdir($baseDir."/slider", 0777, true);
              file_put_contents($baseDir."/slider/slider.json", json_encode($sliderOut, JSON_PRETTY_PRINT));
          }

          // --- Posts ---
          if(isset($data["post"])) {
              foreach($data["post"] as $post) {
                  $cate = $post["cate"];
                  $ids = explode(",", $post["ids"]);
                  $postOut = [];
                  foreach($ids as $id) {
                      $id = trim($id);
                      $tm = time();
                      $playlistURL = "{$baseURL}/pv/playlist.php?id={$id}&tm={$tm}";
                      $jsonData = @file_get_contents($playlistURL, false, $context);
                      if(!$jsonData) continue;
                      $jsonArr = json_decode($jsonData, true);
                      if(isset($jsonArr[0])) {
                          $jsonArr[0]["image2"] = "https://imgcdn.kim/pv/341/{$id}.jpg";
                          $jsonArr[0]["image1"] = "https://imgcdn.kim/pv/c/{$id}.jpg";
                      }
                      $postOut[$id] = $jsonArr;
                  }
                  $safeCate = preg_replace("/[^A-Za-z0-9_-]/", "_", $cate);
                  @mkdir($baseDir."/post/{$safeCate}", 0777, true);
                  file_put_contents($baseDir."/post/{$safeCate}/{$safeCate}.json", json_encode($postOut, JSON_PRETTY_PRINT));
              }
          }

          echo "Homepage slider and post JSON generated successfully.\n";
          '

      - name: Commit and push updated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          mkdir -p pr/slider pr/post

          git add pr/slider/* pr/post/*

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update slider and posts at $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
