name: Auto Update Playlist

on:
  schedule:
    - cron: "*/5 * * * *"   # Run every 5 minutes
  workflow_dispatch:         # Manual trigger option

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    env:
      BASE_URL: ${{ secrets.BASE_URL }}   # Secret for your playlist server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Run playlist generator in-line with User-Agent
        run: |
          php -r '
          $dataFile = __DIR__ . "/pr/data.json";
          $outputM3U = __DIR__ . "/pr/playlist.m3u";
          $outputJSON = __DIR__ . "/pr/playlist.json";

          $baseURL = getenv("BASE_URL");
          if (!$baseURL) die("BASE_URL secret not set\n");

          $data = json_decode(file_get_contents($dataFile), true);
          if (!$data) die("Failed to read data.json\n");

          $m3uContent = "#EXTM3U\n";
          $allJson = [];

          foreach ($data as $item) {
              $id = $item["id"];
              $title = $item["title"] ?? $id;
              $logo = str_replace("$id", $id, $item["logo"] ?? "");

              $tm = time();
              $playlistURL = "{$baseURL}/pv/playlist.php?id={$id}&tm={$tm}";

              // Set browser User-Agent
              $opts = [
                  "http" => [
                      "method" => "GET",
                      "header" => "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36\r\n"
                  ]
              ];
              $context = stream_context_create($opts);

              $jsonData = @file_get_contents($playlistURL, false, $context);
              if (!$jsonData) continue;

              $jsonArr = json_decode($jsonData, true);
              if (!$jsonArr) continue;

              $allJson[$id] = $jsonArr;

              if (isset($jsonArr[0]["sources"])) {
                  foreach ($jsonArr[0]["sources"] as $source) {
                      $file = $source["file"];
                      $label = $source["label"] ?? "Unknown";
                      $m3uContent .= "#EXTINF:-1 tvg-logo=\"{$logo}\" group-title=\"{$title}\",{$title} - {$label}\n";
                      $m3uContent .= $file . "\n";
                  }
              }
          }

          file_put_contents($outputM3U, $m3uContent);
          file_put_contents($outputJSON, json_encode($allJson, JSON_PRETTY_PRINT));
          echo "Playlist generated successfully.\n";
          '

      - name: Commit and push updated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ensure files exist
          touch pr/playlist.m3u pr/playlist.json

          git add pr/playlist.m3u pr/playlist.json

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update playlist at $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
